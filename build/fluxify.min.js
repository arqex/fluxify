/*
fluxify v0.2.0
https://github.com/arqex/fluxify
GNU-2: https://github.com/arqex/fluxify/raw/master/LICENSE
*/
!function(t,e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():t.Foo=e()}(this,function(){"use strict";var t={_extend:function(t){for(var e,i,n=0;n<arguments.length;n++){e=arguments[n];for(i in e)t[i]=e[i]}return t}},e=function(){Object.defineProperty(this,"_events",{value:{}}),"function"==typeof this.initialize&&this.initialize.apply(this,arguments)},i={on:function(t,e,i){var n=this._events[t]||[];return n.push({callback:e,once:i}),this._events[t]=n,this},once:function(t,e){this.on(t,e,!0)},off:function(t,e){if("undefined"==typeof t)this._events={};else if("undefined"==typeof e)this._events[t]=[];else{var i,n=this._events[t]||[];for(i=n.length-1;i>=0;i--)n[i]===e&&n.splice(i,1)}return this},trigger:function(t){var e,i,n=[].slice.call(arguments,1),r=this._events[t]||[],s=[];for(e=0;e<r.length;e++)i=r[e],i.callback.apply(null,n),i.once&&s.push(e);for(e=s.length-1;e>=0;e--)r.splice(s[e],1);return this}};t._extend(i,{addListener:i.on,removeListener:i.off,removeAllListeners:i.off,emit:i.trigger}),e.prototype={};for(var n in i)Object.defineProperty(e.prototype,n,{value:i[n]});Object.defineProperty(e,"_extend",{value:function(e){var i,n=this;i=e&&e.hasOwnProperty(constructor)?e.constructor:function(){return n.apply(this,arguments)},t._extend(i,n);var r=function(){Object.defineProperty(this,"constructor",{value:i})};if(r.prototype=n.prototype,i.prototype=new r,e)for(var s in e)"constructor"!=s&&Object.defineProperty(i.prototype,s,{value:e[s]});return i.__super__=n.prototype,i}});var r=e._extend({initialize:function(t){if(!t)return this.props={};this.props={};for(var e in t)this.props[e]=t[e]},get:function(t){return this.props[t]},set:function(t,e){var i,n,r=t,s=[];"undefined"!=typeof e&&(r={},r[t]=e);for(n in r)this.props[n]!=r[n]&&(i=this.props[n],this.props[n]=r[n],s.push({prop:n,previousValue:i,value:r[n]}));s.length&&this.emit("change",s)}}),s=e._extend({initialize:function(t){var e,i,n=this,s=t||{},o=new r(s.initialState);t.id&&Object.defineProperty(this,"_id",{value:t.id}),Object.defineProperties(this,{_callbacks:{writable:!0,configurable:!0,value:{}},addActionCallbacks:{value:function(t){for(e in t)n._callbacks[e]=t[e].bind(this,o)}},callback:{value:function(){var t=arguments[0],e=[].slice.call(arguments,1);return this._callbacks[t]?this._callbacks[t].apply(this,e):!0}.bind(this)}}),this.addActionCallbacks(s.actionCallbacks||{});var a=function(t){Object.defineProperty(n,t,{enumerable:!0,configurable:!1,get:function(){return o.get(t)}})};if(s.initialState)for(i in s.initialState)a(i,s.initialState[i]);o.on("change",function(t){var e,i,r=t.length;for(i=0;r>i;i++)e=t[i],n.hasOwnProperty(e.prop)||a(e.prop,e.value),n.emit("change:"+e.prop,e.value,e.previousValue);n.emit("change",t)})},getState:function(){var e={};for(var i in this)e[i]=this[i];return t._extend({},e)},waitFor:function(t){return this._dispatcher.waitFor(t)}}),o=function(){this._callbacks={},this._isDispatching=!1,"undefined"!=typeof Promise&&(this._Promise=Promise)};o.prototype={register:function(t,e){var i=t;return"function"==typeof t&&(i="ID_"+(Object.keys(this._callbacks).length+1),e=t),this._callbacks[i]=e,i},registerStore:function(t,e){this._callbacks[t]=e.callback,Object.defineProperty(e,"_dispatcher",{value:this})},unregister:function(t){delete this._callbacks[t]},waitFor:function(t){var e=[],i=0;for(Array.isArray(t)||(t=[t]);i<t.length;i++)this._promises[t[i]]&&e.push(this._promises[t[i]]);return e.length?this._Promise.all(e):this._Promise.resolve()},dispatch:function(){var t,e=this,i=[],n=arguments;if(!this._Promise)throw new TypeError("No promises.");if(this._isDispatching)throw new Error("Cannot dispatch in the middle of a dispatch.");this._promises=[this._isDispatching=!0],Object.keys(this._callbacks).forEach(function(t){e._promises[t]=e._Promise.resolve().then(function(){return e._callbacks[t].apply(e,n)}),i.push(e._promises[t])});var t=this._Promise.all(i).then(function(){e._isDispatching=!1},function(){e._isDispatching=!1});return t},isDispatching:function(){return this._isDispatching}};var a=function(){Object.defineProperty(this,"dispatcher",{value:new o}),this.stores={},"undefined"!=typeof Promise&&this.promisify(Promise)};return a.prototype={createStore:function(t){var e=new s(t);return e._id&&(this.stores[e._id]=e,this.dispatcher.registerStore(e._id,e)),e},doAction:function(){return this.dispatcher.dispatch.apply(this.dispatcher,arguments)},promisify:function(t){this._Promise=t,this.dispatcher._Promise=t}},new a});